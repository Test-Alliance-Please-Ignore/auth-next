<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{{GROUP_NAME}} - Group Details</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			html {
				height: 100%;
				background: linear-gradient(180deg, #0a0e27 0%, #1a1b3d 50%, #2d1b4e 100%) fixed;
			}

			body {
				font-family:
					-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
				min-height: 100%;
				color: white;
				padding: 1.5rem;
			}

			.container {
				max-width: 1200px;
				margin: 0 auto;
			}

			.nav {
				margin-bottom: 1.25rem;
			}

			.nav a {
				color: #a0aec0;
				text-decoration: none;
				transition: color 0.2s;
			}

			.nav a:hover {
				color: white;
			}

			.card {
				background: rgba(255, 255, 255, 0.05);
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.1);
				border-radius: 1rem;
				padding: 1.25rem;
				margin-bottom: 1.5rem;
				box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
			}

			.group-header {
				margin-bottom: 1.25rem;
			}

			.group-header h1 {
				font-size: 2rem;
				margin-bottom: 0.5rem;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
			}

			.group-header p {
				color: #a0aec0;
				font-size: 1rem;
			}

			.group-meta {
				display: flex;
				gap: 0.375rem;
				margin-top: 0.75rem;
				flex-wrap: wrap;
			}

			.badge {
				padding: 0.2rem 0.5rem;
				border-radius: 0.25rem;
				font-size: 0.6875rem;
				font-weight: 600;
				text-transform: uppercase;
			}

			.badge-public {
				background: #d4edda;
				color: #155724;
			}
			.badge-private {
				background: #fff3cd;
				color: #856404;
			}
			.badge-hidden {
				background: #f8d7da;
				color: #721c24;
			}
			.badge-standard {
				background: #d1ecf1;
				color: #0c5460;
			}
			.badge-managed {
				background: #cce5ff;
				color: #004085;
			}
			.badge-derived {
				background: #e7d4ff;
				color: #5a1a99;
			}
			.badge-owner {
				background: #fbbf24;
				color: #78350f;
			}
			.badge-admin {
				background: #3b82f6;
				color: white;
			}
			.badge-moderator {
				background: #10b981;
				color: white;
			}
			.badge-member {
				background: #6b7280;
				color: white;
			}

			.btn {
				display: inline-block;
				padding: 0.5rem 1rem;
				border-radius: 0.5rem;
				font-weight: 600;
				text-decoration: none;
				transition: all 0.2s;
				border: none;
				cursor: pointer;
				font-size: 0.875rem;
			}

			.btn-primary {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
			}

			.btn-primary:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
			}

			.btn-secondary {
				background: rgba(255, 255, 255, 0.1);
				color: white;
				border: 1px solid rgba(255, 255, 255, 0.2);
			}

			.btn-secondary:hover {
				background: rgba(255, 255, 255, 0.15);
			}

			.btn-danger {
				background: #f56565;
				color: white;
			}

			.btn-danger:hover {
				background: #e53e3e;
			}

			.btn-small {
				padding: 0.375rem 0.75rem;
				font-size: 0.8125rem;
			}

			.info-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 0.75rem;
				margin-bottom: 1.25rem;
			}

			.info-item {
				background: rgba(255, 255, 255, 0.05);
				padding: 0.75rem;
				border-radius: 0.5rem;
			}

			.info-label {
				color: #a0aec0;
				font-size: 0.875rem;
				margin-bottom: 0.25rem;
			}

			.info-value {
				color: white;
				font-weight: 600;
				font-size: 1.125rem;
			}

			.tabs {
				display: flex;
				gap: 0.5rem;
				margin-bottom: 1rem;
				border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			}

			.tab {
				padding: 0.5rem 1rem;
				background: none;
				border: none;
				color: #a0aec0;
				cursor: pointer;
				transition: all 0.2s;
				border-bottom: 2px solid transparent;
			}

			.tab:hover {
				color: white;
			}

			.tab.active {
				color: white;
				border-bottom-color: #667eea;
			}

			.tab-content {
				display: none;
			}

			.tab-content.active {
				display: block;
			}

			.members-list {
				display: grid;
				gap: 0.5rem;
			}

			.member-item {
				background: rgba(255, 255, 255, 0.05);
				padding: 0.75rem;
				border-radius: 0.5rem;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.member-info {
				display: flex;
				align-items: center;
				gap: 0.75rem;
			}

			.member-avatar {
				width: 36px;
				height: 36px;
				border-radius: 50%;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				display: flex;
				align-items: center;
				justify-content: center;
				font-weight: 700;
				font-size: 0.875rem;
			}

			.loading {
				text-align: center;
				padding: 3rem;
				color: #a0aec0;
			}

			.empty {
				text-align: center;
				padding: 3rem;
			}

			.empty h3 {
				color: white;
				margin-bottom: 0.5rem;
			}

			.empty p {
				color: #a0aec0;
			}

			.actions {
				display: flex;
				gap: 0.75rem;
				margin-top: 1rem;
				flex-wrap: wrap;
			}

			.request-item {
				background: rgba(255, 255, 255, 0.05);
				padding: 0.75rem;
				border-radius: 0.5rem;
				margin-bottom: 0.5rem;
			}

			.request-header {
				display: flex;
				justify-content: space-between;
				align-items: start;
				margin-bottom: 0.5rem;
			}

			.request-actions {
				display: flex;
				gap: 0.5rem;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="nav">
				<a href="/groups">← Back to All Groups</a>
			</div>

			<div class="card">
				<div class="group-header">
					<h1 id="group-name">Loading...</h1>
					<p id="group-description"></p>
					<div class="group-meta" id="group-meta"></div>
				</div>

				<div class="info-grid" id="group-info"></div>

				<div id="member-actions" class="actions" style="display: none"></div>

				<div class="tabs">
					<button class="tab active" onclick="switchTab('members')">Members</button>
					<button
						class="tab"
						id="requests-tab"
						onclick="switchTab('requests')"
						style="display: none"
					>
						Join Requests
					</button>
				</div>

				<div id="members" class="tab-content active">
					<div id="members-list">
						<div class="loading">Loading members...</div>
					</div>
				</div>

				<div id="requests" class="tab-content">
					<div id="requests-list">
						<div class="loading">Loading join requests...</div>
					</div>
				</div>
			</div>
		</div>

		<script>
			const slug = window.location.pathname.split('/').pop()
			let currentGroup = null
			let currentUserRole = null

			async function loadGroupDetails() {
				try {
					const response = await fetch(`/api/groups/${slug}`, {
						credentials: 'same-origin',
					})

					if (!response.ok) {
						throw new Error('Failed to load group')
					}

					const data = await response.json()
					currentGroup = data.group
					displayGroupDetails(currentGroup)
					loadMembers()
					checkUserMembership()
				} catch (error) {
					console.error('Failed to load group:', error)
					document.getElementById('group-name').textContent = 'Error Loading Group'
				}
			}

			function displayGroupDetails(group) {
				document.title = `${group.name} - Group Details`
				document.getElementById('group-name').textContent = group.name
				document.getElementById('group-description').textContent =
					group.description || 'No description'

				document.getElementById('group-meta').innerHTML = `
				<span class="badge badge-${group.visibility}">${group.visibility}</span>
				<span class="badge badge-${group.groupType}">${group.groupType}</span>
				<span class="badge">${group.joinability.replace('_', ' ')}</span>
			`

				document.getElementById('group-info').innerHTML = `
				<div class="info-item">
					<div class="info-label">Owner</div>
					<div class="info-value">${group.ownerName || 'Unknown'}</div>
				</div>
				<div class="info-item">
					<div class="info-label">Created</div>
					<div class="info-value">${new Date(group.createdAt).toLocaleDateString()}</div>
				</div>
				<div class="info-item">
					<div class="info-label">Type</div>
					<div class="info-value">${group.groupType}</div>
				</div>
				<div class="info-item">
					<div class="info-label">Can Leave</div>
					<div class="info-value">${group.isLeaveable ? 'Yes' : 'No'}</div>
				</div>
			`
			}

			async function checkUserMembership() {
				try {
					const response = await fetch(`/api/users/me/groups`, {
						credentials: 'same-origin',
					})

					if (!response.ok) {
						// Not authenticated
						showJoinButton()
						return
					}

					const data = await response.json()
					const membership = data.groups.find((g) => g.slug === slug)

					if (membership) {
						currentUserRole = membership.membership?.role || 'member'
						showMemberActions(membership)

						// Show join requests tab if admin or owner
						if (currentUserRole === 'admin' || currentUserRole === 'owner') {
							document.getElementById('requests-tab').style.display = 'block'
						}
					} else {
						showJoinButton()
					}
				} catch (error) {
					console.error('Failed to check membership:', error)
				}
			}

			function showJoinButton() {
				const actionsDiv = document.getElementById('member-actions')
				actionsDiv.style.display = 'flex'
				actionsDiv.style.flexDirection = 'column'
				actionsDiv.style.alignItems = 'flex-start'
				actionsDiv.style.gap = '1rem'

				if (currentGroup.joinability === 'closed') {
					actionsDiv.innerHTML = `<p style="color: #a0aec0;">This group is not accepting new members</p>`
				} else if (currentGroup.joinability === 'invite_only') {
					actionsDiv.innerHTML = `
					<p style="color: #a0aec0;">This group is invite-only. Enter an invite code to join:</p>
					<div style="display: flex; gap: 0.5rem; width: 100%;">
						<input
							type="text"
							id="invite-code-input"
							placeholder="Enter invite code..."
							style="flex: 1; padding: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.5rem; background: rgba(255, 255, 255, 0.05); color: white; font-size: 1rem;"
						>
						<button onclick="redeemInviteCode()" class="btn btn-primary">Join with Code</button>
					</div>
				`
				} else {
					const buttonText = currentGroup.joinability === 'open' ? 'Join Group' : 'Request to Join'
					actionsDiv.innerHTML = `<button onclick="joinGroup()" class="btn btn-primary">${buttonText}</button>`
				}
			}

			function showMemberActions(membership) {
				const actionsDiv = document.getElementById('member-actions')
				actionsDiv.style.display = 'flex'
				actionsDiv.style.alignItems = 'center'

				let html = `<span class="badge badge-${membership.membership?.role}">Your Role: ${membership.membership?.role || 'member'}</span>`

				if (membership.isLeaveable && membership.membership?.canLeave) {
					html += `<button onclick="leaveGroup()" class="btn btn-danger">Leave Group</button>`
				}

				if (currentUserRole === 'admin' || currentUserRole === 'owner') {
					html += `<a href="/groups/${slug}/manage" class="btn btn-primary">Manage Group</a>`
				}

				actionsDiv.innerHTML = html
			}

			async function loadMembers() {
				try {
					const response = await fetch(`/api/groups/${slug}/members`, {
						credentials: 'same-origin',
					})

					if (!response.ok) {
						throw new Error('Failed to load members')
					}

					const data = await response.json()
					displayMembers(data.members)
				} catch (error) {
					console.error('Failed to load members:', error)
					document.getElementById('members-list').innerHTML = `
					<div class="empty">
						<h3>Error Loading Members</h3>
						<p>Please try again later</p>
					</div>
				`
				}
			}

			function displayMembers(members) {
				const container = document.getElementById('members-list')

				if (members.length === 0) {
					container.innerHTML = `
					<div class="empty">
						<h3>No Members Yet</h3>
						<p>Be the first to join!</p>
					</div>
				`
					return
				}

				container.innerHTML = `
				<div class="members-list">
					${members
						.map((member) => {
							const displayName =
								member.characterName || member.socialUserId.substring(0, 12) + '...'
							const initials = member.characterName
								? member.characterName.substring(0, 2).toUpperCase()
								: member.socialUserId.substring(0, 2).toUpperCase()
							return `
							<div class="member-item">
								<div class="member-info">
									<div class="member-avatar">${initials}</div>
									<div style="color: white; font-weight: 600;">${escapeHtml(displayName)}</div>
									<div style="color: #a0aec0; font-size: 0.8125rem;">— Joined ${new Date(member.joinedAt).toLocaleDateString()}</div>
								</div>
								<div style="display: flex; gap: 0.5rem; align-items: center;">
									<span class="badge badge-${member.role}">${member.role}</span>
									${
										(currentUserRole === 'admin' || currentUserRole === 'owner') &&
										member.role !== 'owner'
											? `
										<button onclick="kickMember('${member.socialUserId}')" class="btn btn-danger btn-small">Kick</button>
									`
											: ''
									}
								</div>
							</div>
						`
						})
						.join('')}
				</div>
			`
			}

			async function loadJoinRequests() {
				try {
					const response = await fetch(`/api/groups/${slug}/requests?status=pending`, {
						credentials: 'same-origin',
					})

					if (!response.ok) {
						throw new Error('Failed to load requests')
					}

					const data = await response.json()
					displayJoinRequests(data.requests)
				} catch (error) {
					console.error('Failed to load requests:', error)
					document.getElementById('requests-list').innerHTML = `
					<div class="empty">
						<h3>Error Loading Requests</h3>
						<p>Please try again later</p>
					</div>
				`
				}
			}

			function displayJoinRequests(requests) {
				const container = document.getElementById('requests-list')

				if (requests.length === 0) {
					container.innerHTML = `
					<div class="empty">
						<h3>No Pending Requests</h3>
						<p>No one is waiting to join</p>
					</div>
				`
					return
				}

				container.innerHTML = requests
					.map((request) => {
						const displayName =
							request.characterName || request.socialUserId.substring(0, 12) + '...'
						return `
					<div class="request-item">
						<div class="request-header">
							<div>
								<div style="color: white; font-weight: 600;">${escapeHtml(displayName)}</div>
								<div style="color: #a0aec0; font-size: 0.875rem;">${new Date(request.createdAt).toLocaleDateString()}</div>
								${request.message ? `<p style="color: #a0aec0; margin-top: 0.5rem;">${escapeHtml(request.message)}</p>` : ''}
							</div>
							<div class="request-actions">
								<button onclick="approveRequest('${request.requestId}')" class="btn btn-primary btn-small">Approve</button>
								<button onclick="rejectRequest('${request.requestId}')" class="btn btn-secondary btn-small">Reject</button>
							</div>
						</div>
					</div>
				`
					})
					.join('')
			}

			function switchTab(tabName) {
				document.querySelectorAll('.tab').forEach((tab) => {
					tab.classList.remove('active')
				})
				event.target.classList.add('active')

				document.querySelectorAll('.tab-content').forEach((content) => {
					content.classList.remove('active')
				})
				document.getElementById(tabName).classList.add('active')

				if (tabName === 'requests') {
					loadJoinRequests()
				}
			}

			async function joinGroup() {
				try {
					const response = await fetch(`/api/groups/${slug}/join`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						credentials: 'same-origin',
						body: JSON.stringify({}),
					})

					if (!response.ok) {
						const error = await response.json()
						throw new Error(error.error || 'Failed to join group')
					}

					const data = await response.json()
					alert(data.message)
					location.reload()
				} catch (error) {
					alert('Error: ' + error.message)
				}
			}

			async function leaveGroup() {
				if (!confirm('Are you sure you want to leave this group?')) {
					return
				}

				try {
					const response = await fetch(`/api/groups/${slug}/leave`, {
						method: 'DELETE',
						credentials: 'same-origin',
					})

					if (!response.ok) {
						const error = await response.json()
						throw new Error(error.error || 'Failed to leave group')
					}

					window.location.href = '/groups/dashboard'
				} catch (error) {
					alert('Error: ' + error.message)
				}
			}

			async function kickMember(memberId) {
				if (!confirm('Are you sure you want to kick this member?')) {
					return
				}

				try {
					const response = await fetch(`/api/groups/${slug}/members/${memberId}`, {
						method: 'DELETE',
						credentials: 'same-origin',
					})

					if (!response.ok) {
						const error = await response.json()
						throw new Error(error.error || 'Failed to kick member')
					}

					loadMembers()
				} catch (error) {
					alert('Error: ' + error.message)
				}
			}

			async function approveRequest(requestId) {
				try {
					const response = await fetch(`/api/groups/${slug}/requests/${requestId}/approve`, {
						method: 'POST',
						credentials: 'same-origin',
					})

					if (!response.ok) {
						const error = await response.json()
						throw new Error(error.error || 'Failed to approve request')
					}

					loadJoinRequests()
					loadMembers()
				} catch (error) {
					alert('Error: ' + error.message)
				}
			}

			async function rejectRequest(requestId) {
				try {
					const response = await fetch(`/api/groups/${slug}/requests/${requestId}/reject`, {
						method: 'POST',
						credentials: 'same-origin',
					})

					if (!response.ok) {
						const error = await response.json()
						throw new Error(error.error || 'Failed to reject request')
					}

					loadJoinRequests()
				} catch (error) {
					alert('Error: ' + error.message)
				}
			}

			async function redeemInviteCode() {
				const codeInput = document.getElementById('invite-code-input')
				const code = codeInput.value.trim()

				if (!code) {
					alert('Please enter an invite code')
					return
				}

				try {
					const response = await fetch(`/api/invite-codes/${code}/redeem`, {
						method: 'POST',
						credentials: 'same-origin',
					})

					if (!response.ok) {
						const error = await response.json()
						throw new Error(error.error || 'Failed to redeem invite code')
					}

					const data = await response.json()
					alert(data.message || 'Successfully joined the group!')
					location.reload()
				} catch (error) {
					alert('Error: ' + error.message)
				}
			}

			function escapeHtml(text) {
				const map = {
					'&': '&amp;',
					'<': '&lt;',
					'>': '&gt;',
					'"': '&quot;',
					"'": '&#039;',
				}
				return text.replace(/[&<>"']/g, (m) => map[m])
			}

			// Initialize
			loadGroupDetails()
		</script>
	</body>
</html>
