<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>My Groups Dashboard</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		html {
			height: 100%;
			background: linear-gradient(180deg, #0a0e27 0%, #1a1b3d 50%, #2d1b4e 100%) fixed;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
			min-height: 100%;
			color: white;
			padding: 2rem;
			position: relative;
			overflow-x: hidden;
		}

		/* Starfield background */
		@keyframes twinkle {
			0%, 100% { opacity: 0.3; }
			50% { opacity: 1; }
		}

		.stars {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			pointer-events: none;
			z-index: 0;
		}

		.star {
			position: absolute;
			width: 2px;
			height: 2px;
			background: white;
			border-radius: 50%;
			animation: twinkle 3s ease-in-out infinite;
		}

		.container {
			position: relative;
			z-index: 1;
			max-width: 1400px;
			margin: 0 auto;
		}

		.header {
			margin-bottom: 1.5rem;
			display: flex;
			justify-content: space-between;
			align-items: center;
			flex-wrap: wrap;
			gap: 1rem;
		}

		.header h1 {
			font-size: 2rem;
			font-weight: 700;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

		.header-actions {
			display: flex;
			gap: 1rem;
		}

		.card {
			background: rgba(255, 255, 255, 0.05);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 1rem;
			padding: 1.25rem;
			margin-bottom: 1.5rem;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
		}

		.card h2 {
			font-size: 1.25rem;
			margin-bottom: 1rem;
			color: #e2e8f0;
		}

		.btn {
			display: inline-block;
			padding: 0.5rem 1rem;
			border-radius: 0.5rem;
			font-weight: 600;
			text-decoration: none;
			transition: all 0.2s;
			border: none;
			cursor: pointer;
			font-size: 0.875rem;
		}

		.btn-primary {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
		}

		.btn-primary:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
		}

		.btn-secondary {
			background: rgba(255, 255, 255, 0.1);
			color: white;
			border: 1px solid rgba(255, 255, 255, 0.2);
		}

		.btn-secondary:hover {
			background: rgba(255, 255, 255, 0.15);
		}

		.btn-danger {
			background: #f56565;
			color: white;
		}

		.btn-danger:hover {
			background: #e53e3e;
		}

		.btn-small {
			padding: 0.375rem 0.75rem;
			font-size: 0.8125rem;
		}

		.tabs {
			display: flex;
			gap: 0.5rem;
			margin-bottom: 1rem;
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
		}

		.tab {
			padding: 0.5rem 1rem;
			background: none;
			border: none;
			color: #a0aec0;
			cursor: pointer;
			transition: all 0.2s;
			border-bottom: 2px solid transparent;
		}

		.tab:hover {
			color: white;
		}

		.tab.active {
			color: white;
			border-bottom-color: #667eea;
		}

		.tab-content {
			display: none;
		}

		.tab-content.active {
			display: block;
		}

		.groups-list {
			display: grid;
			gap: 0.75rem;
		}

		.group-item {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 0.5rem;
			padding: 0.75rem 1rem;
			transition: all 0.2s;
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 1rem;
			flex-wrap: wrap;
		}

		.group-item:hover {
			background: rgba(255, 255, 255, 0.08);
			transform: translateY(-2px);
		}

		.group-header {
			flex: 1;
			min-width: 250px;
		}

		.group-header h3 {
			font-size: 1rem;
			color: white;
			line-height: 1.3;
			display: inline;
			margin-right: 0.5rem;
		}

		.group-header p {
			color: #a0aec0;
			font-size: 0.8125rem;
			line-height: 1.3;
			display: inline;
		}

		.group-meta {
			display: flex;
			gap: 0.375rem;
			flex-wrap: wrap;
			align-items: center;
		}

		.badge {
			padding: 0.2rem 0.5rem;
			border-radius: 0.25rem;
			font-size: 0.6875rem;
			font-weight: 600;
			text-transform: uppercase;
		}

		.badge-owner { background: #fbbf24; color: #78350f; }
		.badge-admin { background: #3b82f6; color: white; }
		.badge-moderator { background: #10b981; color: white; }
		.badge-member { background: #6b7280; color: white; }
		.badge-public { background: #d4edda; color: #155724; }
		.badge-private { background: #fff3cd; color: #856404; }
		.badge-standard { background: #d1ecf1; color: #0c5460; }
		.badge-managed { background: #cce5ff; color: #004085; }
		.badge-derived { background: #e7d4ff; color: #5a1a99; }

		.group-actions {
			display: flex;
			gap: 0.5rem;
			flex-wrap: wrap;
		}

		.invites-list {
			display: grid;
			gap: 0.75rem;
		}

		.invite-item {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 0.5rem;
			padding: 0.75rem 1rem;
			display: flex;
			justify-content: space-between;
			align-items: center;
			flex-wrap: wrap;
			gap: 0.75rem;
		}

		.invite-info h4 {
			color: white;
			display: inline;
			margin-right: 0.5rem;
		}

		.invite-info p {
			color: #a0aec0;
			font-size: 0.8125rem;
			display: inline;
		}

		.invite-actions {
			display: flex;
			gap: 0.5rem;
		}

		.loading {
			text-align: center;
			padding: 3rem;
			color: #a0aec0;
		}

		.empty {
			text-align: center;
			padding: 3rem;
		}

		.empty h3 {
			color: white;
			margin-bottom: 0.5rem;
		}

		.empty p {
			color: #a0aec0;
		}

		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.8);
			z-index: 1000;
			align-items: center;
			justify-content: center;
			padding: 2rem;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: #1a202c;
			border-radius: 1rem;
			padding: 1.5rem;
			max-width: 500px;
			width: 100%;
		}

		.modal-content h3 {
			margin-bottom: 0.75rem;
			color: white;
		}

		.form-group {
			margin-bottom: 1rem;
		}

		.form-group label {
			display: block;
			margin-bottom: 0.5rem;
			color: #e2e8f0;
			font-weight: 600;
		}

		.form-group input,
		.form-group textarea,
		.form-group select {
			width: 100%;
			padding: 0.75rem;
			border: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: 0.5rem;
			background: rgba(255, 255, 255, 0.05);
			color: white;
			font-size: 1rem;
		}

		.form-group select option {
			background: #1a202c;
			color: white;
		}

		.form-group select option:disabled {
			color: #718096;
		}

		.form-group textarea {
			resize: vertical;
			min-height: 100px;
		}

		.form-actions {
			display: flex;
			gap: 0.75rem;
			justify-content: flex-end;
			margin-top: 1rem;
		}

		.info-row {
			display: flex;
			justify-content: space-between;
			padding: 0.75rem;
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
		}

		.info-row:last-child {
			border-bottom: none;
		}

		.info-label {
			color: #a0aec0;
			font-weight: 600;
		}

		.info-value {
			color: white;
		}

		.category-section {
			margin-bottom: 2rem;
		}

		.category-header {
			margin-bottom: 1rem;
			padding-bottom: 0.5rem;
			border-bottom: 2px solid rgba(102, 126, 234, 0.3);
		}

		.category-header h3 {
			font-size: 1.125rem;
			color: #667eea;
			margin-bottom: 0.25rem;
		}

		.category-header p {
			font-size: 0.875rem;
			color: #a0aec0;
		}

		.category-list {
			display: grid;
			gap: 0.75rem;
			margin-bottom: 1rem;
		}

		.category-item {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 0.5rem;
			padding: 0.75rem 1rem;
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 1rem;
		}

		.category-info {
			flex: 1;
		}

		.category-info h4 {
			color: white;
			font-size: 0.9375rem;
			margin-bottom: 0.25rem;
		}

		.category-info p {
			color: #a0aec0;
			font-size: 0.8125rem;
			margin-bottom: 0.25rem;
		}

		.category-info .order-badge {
			display: inline-block;
			background: rgba(102, 126, 234, 0.2);
			color: #667eea;
			padding: 0.2rem 0.5rem;
			border-radius: 0.25rem;
			font-size: 0.75rem;
			font-weight: 600;
		}

		.category-actions {
			display: flex;
			gap: 0.5rem;
		}
	</style>
</head>
<body>
	<div class="stars" id="stars"></div>

	<div class="container">
		<div class="header">
			<h1>Groups</h1>
			<div class="header-actions">
				<button id="manage-categories-btn" onclick="openManageCategoriesModal()" class="btn btn-secondary" style="display: none;">Manage Categories</button>
				<button onclick="openCreateGroupModal()" class="btn btn-primary">Create Group</button>
			</div>
		</div>

		<div class="card">
			<div class="tabs">
				<button class="tab active" onclick="switchTab('my-groups')">My Groups</button>
				<button class="tab" onclick="switchTab('browse')">Browse All</button>
				<button class="tab" onclick="switchTab('invites')">Invitations</button>
			</div>

			<div id="my-groups" class="tab-content active">
				<div id="groups-list">
					<div class="loading">Loading your groups...</div>
				</div>
			</div>

			<div id="browse" class="tab-content">
				<div id="browse-list">
					<div class="loading">Loading groups...</div>
				</div>
			</div>

			<div id="invites" class="tab-content">
				<div id="invites-list">
					<div class="loading">Loading invitations...</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Create Group Modal -->
	<div id="create-group-modal" class="modal">
		<div class="modal-content">
			<h3>Create New Group</h3>
			<form id="create-group-form">
				<div class="form-group">
					<label for="group-name">Group Name *</label>
					<input type="text" id="group-name" required>
				</div>
				<div class="form-group">
					<label for="group-description">Description</label>
					<textarea id="group-description"></textarea>
				</div>
				<div class="form-group">
					<label for="group-category">Category (Optional)</label>
					<select id="group-category">
						<option value="">No Category</option>
					</select>
				</div>
				<div class="form-group">
					<label for="group-type">Type</label>
					<select id="group-type">
						<option value="standard">Standard</option>
						<option value="managed">Managed</option>
						<option value="derived">Derived</option>
					</select>
				</div>
				<div class="form-group">
					<label for="group-visibility">Visibility</label>
					<select id="group-visibility">
						<option value="public">Public</option>
						<option value="private">Private</option>
						<option value="hidden">Hidden</option>
					</select>
				</div>
				<div class="form-group">
					<label for="group-joinability">Joinability</label>
					<select id="group-joinability">
						<option value="open">Open</option>
						<option value="approval_required">Approval Required</option>
						<option value="invite_only">Invite Only</option>
						<option value="closed">Closed</option>
					</select>
				</div>
				<div class="form-actions">
					<button type="button" onclick="closeCreateGroupModal()" class="btn btn-secondary">Cancel</button>
					<button type="submit" class="btn btn-primary">Create Group</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Manage Categories Modal -->
	<div id="manage-categories-modal" class="modal">
		<div class="modal-content" style="max-width: 700px;">
			<h3>Manage Categories</h3>
			<div id="categories-container">
				<div class="loading">Loading categories...</div>
			</div>
			<div class="form-actions">
				<button type="button" onclick="showAddCategoryForm()" class="btn btn-primary">Add Category</button>
				<button type="button" onclick="closeManageCategoriesModal()" class="btn btn-secondary">Close</button>
			</div>
		</div>
	</div>

	<!-- Add/Edit Category Modal -->
	<div id="category-form-modal" class="modal">
		<div class="modal-content">
			<h3 id="category-form-title">Add Category</h3>
			<form id="category-form">
				<input type="hidden" id="category-id">
				<div class="form-group">
					<label for="category-name">Name *</label>
					<input type="text" id="category-name" required>
				</div>
				<div class="form-group">
					<label for="category-description">Description</label>
					<textarea id="category-description"></textarea>
				</div>
				<div class="form-group">
					<label for="category-order">Display Order *</label>
					<input type="number" id="category-order" min="0" required>
				</div>
				<div class="form-actions">
					<button type="button" onclick="closeCategoryForm()" class="btn btn-secondary">Cancel</button>
					<button type="submit" class="btn btn-primary">Save</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		// Global state
		let isAdmin = false;
		let categoriesData = [];

		// Generate starfield
		const starsContainer = document.getElementById('stars');
		for (let i = 0; i < 100; i++) {
			const star = document.createElement('div');
			star.className = 'star';
			star.style.left = Math.random() * 100 + '%';
			star.style.top = Math.random() * 100 + '%';
			star.style.animationDelay = Math.random() * 3 + 's';
			starsContainer.appendChild(star);
		}

		function switchTab(tabName) {
			// Update tabs
			document.querySelectorAll('.tab').forEach(tab => {
				tab.classList.remove('active');
			});
			event.target.classList.add('active');

			// Update content
			document.querySelectorAll('.tab-content').forEach(content => {
				content.classList.remove('active');
			});
			document.getElementById(tabName).classList.add('active');

			// Load data if needed
			if (tabName === 'invites') {
				loadInvites();
			} else if (tabName === 'browse') {
				loadBrowseGroups();
			}
		}

		async function loadMyGroups() {
			try {
				const response = await fetch('/api/users/me/groups', {
					credentials: 'same-origin'
				});

				if (!response.ok) {
					throw new Error('Failed to load groups');
				}

				const data = await response.json();
				displayMyGroups(data.groups);
			} catch (error) {
				console.error('Failed to load groups:', error);
				document.getElementById('groups-list').innerHTML = `
					<div class="empty">
						<h3>Error Loading Groups</h3>
						<p>Please try again later</p>
					</div>
				`;
			}
		}

		function displayMyGroups(groups) {
			const container = document.getElementById('groups-list');

			if (groups.length === 0) {
				container.innerHTML = `
					<div class="empty">
						<h3>No Groups Yet</h3>
						<p>Create or join a group to get started!</p>
					</div>
				`;
				return;
			}

			container.innerHTML = `
				<div class="groups-list">
					${groups.map(group => {
						const membership = group.membership || {};
						return `
							<div class="group-item">
								<div class="group-header">
									<h3>${escapeHtml(group.name)}</h3>
									<p>— ${escapeHtml(group.description || 'No description')}</p>
								</div>
								<div class="group-meta">
									<span class="badge badge-${membership.role || 'member'}">${membership.role || 'member'}</span>
									<span class="badge badge-${group.visibility}">${group.visibility}</span>
									<span class="badge badge-${group.groupType}">${group.groupType}</span>
								</div>
								<div class="group-actions">
									<a href="/groups/${group.slug}" class="btn btn-secondary btn-small">View Details</a>
									${group.isLeaveable && membership.canLeave ? `
										<button onclick="leaveGroup('${group.slug}')" class="btn btn-danger btn-small">Leave Group</button>
									` : ''}
								</div>
							</div>
						`;
					}).join('')}
				</div>
			`;
		}

		async function loadInvites() {
			try {
				const response = await fetch('/api/users/me/invites', {
					credentials: 'same-origin'
				});

				if (!response.ok) {
					throw new Error('Failed to load invites');
				}

				const data = await response.json();
				displayInvites(data.invites);
			} catch (error) {
				console.error('Failed to load invites:', error);
				document.getElementById('invites-list').innerHTML = `
					<div class="empty">
						<h3>Error Loading Invitations</h3>
						<p>Please try again later</p>
					</div>
				`;
			}
		}

		function displayInvites(invites) {
			const container = document.getElementById('invites-list');

			if (invites.length === 0) {
				container.innerHTML = `
					<div class="empty">
						<h3>No Pending Invitations</h3>
						<p>You don't have any pending group invitations</p>
					</div>
				`;
				return;
			}

			container.innerHTML = `
				<div class="invites-list">
					${invites.map(invite => `
						<div class="invite-item">
							<div class="invite-info">
								<h4>${escapeHtml(invite.groupName || 'Group Invitation')}</h4>
								<p>— Expires: ${new Date(invite.expiresAt).toLocaleDateString()}</p>
							</div>
							<div class="invite-actions">
								<button onclick="acceptInvite('${invite.inviteId}')" class="btn btn-primary btn-small">Accept</button>
								<button onclick="declineInvite('${invite.inviteId}')" class="btn btn-secondary btn-small">Decline</button>
							</div>
						</div>
					`).join('')}
				</div>
			`;
		}

		async function loadBrowseGroups() {
			try {
				// Fetch both groups and categories in parallel
				const [groupsResponse, categoriesResponse] = await Promise.all([
					fetch('/api/groups', { credentials: 'same-origin' }),
					fetch('/api/categories', { credentials: 'same-origin' })
				]);

				if (!groupsResponse.ok) {
					throw new Error('Failed to load groups');
				}

				const groupsData = await groupsResponse.json();
				const categoriesData = categoriesResponse.ok ? await categoriesResponse.json() : { categories: [] };

				displayBrowseGroups(groupsData.groups, categoriesData.categories);
			} catch (error) {
				console.error('Failed to load groups:', error);
				document.getElementById('browse-list').innerHTML = `
					<div class="empty">
						<h3>Error Loading Groups</h3>
						<p>Please try again later</p>
					</div>
				`;
			}
		}

		function displayBrowseGroups(groups, categories = []) {
			const container = document.getElementById('browse-list');

			if (groups.length === 0) {
				container.innerHTML = `
					<div class="empty">
						<h3>No Groups Found</h3>
						<p>Be the first to create a group!</p>
					</div>
				`;
				return;
			}

			// Sort categories by displayOrder
			const sortedCategories = [...categories].sort((a, b) => a.displayOrder - b.displayOrder);

			// Group the groups by categoryId
			const groupsByCategory = new Map();
			const uncategorizedGroups = [];

			groups.forEach(group => {
				if (group.categoryId) {
					if (!groupsByCategory.has(group.categoryId)) {
						groupsByCategory.set(group.categoryId, []);
					}
					groupsByCategory.get(group.categoryId).push(group);
				} else {
					uncategorizedGroups.push(group);
				}
			});

			// Render group item HTML
			const renderGroupItem = (group) => `
				<div class="group-item">
					<div class="group-header">
						<h3>${escapeHtml(group.name)}</h3>
						<p>— ${escapeHtml(group.description || 'No description')}</p>
					</div>
					<div class="group-meta">
						<span class="badge badge-${group.visibility}">${group.visibility}</span>
						<span class="badge badge-${group.groupType}">${group.groupType}</span>
					</div>
					<div class="group-actions">
						<a href="/groups/${group.slug}" class="btn btn-secondary btn-small">View Group</a>
					</div>
				</div>
			`;

			// Build HTML sections
			let html = '';

			// Render categorized groups
			sortedCategories.forEach(category => {
				const categoryGroups = groupsByCategory.get(category.categoryId) || [];
				if (categoryGroups.length > 0) {
					html += `
						<div class="category-section">
							<div class="category-header">
								<h3>${escapeHtml(category.name)}</h3>
								${category.description ? `<p>${escapeHtml(category.description)}</p>` : ''}
							</div>
							<div class="groups-list">
								${categoryGroups.map(renderGroupItem).join('')}
							</div>
						</div>
					`;
				}
			});

			// Render uncategorized groups in "Other" section
			if (uncategorizedGroups.length > 0) {
				html += `
					<div class="category-section">
						<div class="category-header">
							<h3>Other</h3>
							<p>Uncategorized groups</p>
						</div>
						<div class="groups-list">
							${uncategorizedGroups.map(renderGroupItem).join('')}
						</div>
					</div>
				`;
			}

			container.innerHTML = html;
		}

		async function openCreateGroupModal() {
			const modal = document.getElementById('create-group-modal');
			const groupTypeSelect = document.getElementById('group-type');
			const categorySelect = document.getElementById('group-category');

			// Show/hide managed and derived options based on admin status
			const options = groupTypeSelect.querySelectorAll('option');
			options.forEach(option => {
				if ((option.value === 'managed' || option.value === 'derived') && !isAdmin) {
					option.disabled = true;
					option.textContent = option.textContent + ' (Admin Only)';
				}
			});

			// Load and populate categories
			try {
				const response = await fetch('/api/categories', { credentials: 'same-origin' });
				if (response.ok) {
					const data = await response.json();
					const categories = data.categories.sort((a, b) => a.displayOrder - b.displayOrder);

					// Clear existing options except "No Category"
					categorySelect.innerHTML = '<option value="">No Category</option>';

					// Add category options
					categories.forEach(category => {
						const option = document.createElement('option');
						option.value = category.categoryId;
						option.textContent = category.name;
						categorySelect.appendChild(option);
					});
				}
			} catch (error) {
				console.error('Failed to load categories:', error);
			}

			modal.classList.add('active');
		}

		function closeCreateGroupModal() {
			document.getElementById('create-group-modal').classList.remove('active');
			document.getElementById('create-group-form').reset();
		}

		document.getElementById('create-group-form').addEventListener('submit', async (e) => {
			e.preventDefault();

			const categoryValue = document.getElementById('group-category').value;
			const formData = {
				name: document.getElementById('group-name').value,
				description: document.getElementById('group-description').value,
				groupType: document.getElementById('group-type').value,
				visibility: document.getElementById('group-visibility').value,
				joinability: document.getElementById('group-joinability').value
			};

			// Only include categoryId if a category was selected
			if (categoryValue) {
				formData.categoryId = categoryValue;
			}

			try {
				const response = await fetch('/api/groups', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					credentials: 'same-origin',
					body: JSON.stringify(formData)
				});

				if (!response.ok) {
					const error = await response.json();
					throw new Error(error.error || 'Failed to create group');
				}

				const data = await response.json();
				closeCreateGroupModal();
				window.location.href = `/groups/${data.group.slug}`;
			} catch (error) {
				alert('Error creating group: ' + error.message);
			}
		});

		async function leaveGroup(slug) {
			if (!confirm('Are you sure you want to leave this group?')) {
				return;
			}

			try {
				const response = await fetch(`/api/groups/${slug}/leave`, {
					method: 'DELETE',
					credentials: 'same-origin'
				});

				if (!response.ok) {
					const error = await response.json();
					throw new Error(error.error || 'Failed to leave group');
				}

				loadMyGroups();
			} catch (error) {
				alert('Error leaving group: ' + error.message);
			}
		}

		async function acceptInvite(inviteId) {
			try {
				const response = await fetch(`/api/invites/${inviteId}/accept`, {
					method: 'POST',
					credentials: 'same-origin'
				});

				if (!response.ok) {
					const error = await response.json();
					throw new Error(error.error || 'Failed to accept invite');
				}

				loadInvites();
				loadMyGroups();
			} catch (error) {
				alert('Error accepting invite: ' + error.message);
			}
		}

		async function declineInvite(inviteId) {
			try {
				const response = await fetch(`/api/invites/${inviteId}/decline`, {
					method: 'POST',
					credentials: 'same-origin'
				});

				if (!response.ok) {
					const error = await response.json();
					throw new Error(error.error || 'Failed to decline invite');
				}

				loadInvites();
			} catch (error) {
				alert('Error declining invite: ' + error.message);
			}
		}

		function escapeHtml(text) {
			const map = {
				'&': '&amp;',
				'<': '&lt;',
				'>': '&gt;',
				'"': '&quot;',
				"'": '&#039;'
			};
			return text.replace(/[&<>"']/g, m => map[m]);
		}

		// Category Management Functions
		async function openManageCategoriesModal() {
			const modal = document.getElementById('manage-categories-modal');
			modal.classList.add('active');
			await loadCategories();
		}

		function closeManageCategoriesModal() {
			document.getElementById('manage-categories-modal').classList.remove('active');
		}

		async function loadCategories() {
			const container = document.getElementById('categories-container');
			try {
				const response = await fetch('/api/categories', { credentials: 'same-origin' });
				if (!response.ok) {
					throw new Error('Failed to load categories');
				}

				const data = await response.json();
				categoriesData = data.categories.sort((a, b) => a.displayOrder - b.displayOrder);

				if (categoriesData.length === 0) {
					container.innerHTML = '<div class="empty"><p>No categories yet. Create one to get started!</p></div>';
					return;
				}

				container.innerHTML = `
					<div class="category-list">
						${categoriesData.map(category => `
							<div class="category-item">
								<div class="category-info">
									<h4>${escapeHtml(category.name)}</h4>
									${category.description ? `<p>${escapeHtml(category.description)}</p>` : ''}
									<span class="order-badge">Order: ${category.displayOrder}</span>
								</div>
								<div class="category-actions">
									<button onclick="editCategory('${category.categoryId}')" class="btn btn-secondary btn-small">Edit</button>
									<button onclick="deleteCategory('${category.categoryId}')" class="btn btn-danger btn-small">Delete</button>
								</div>
							</div>
						`).join('')}
					</div>
				`;
			} catch (error) {
				console.error('Failed to load categories:', error);
				container.innerHTML = '<div class="empty"><p>Error loading categories</p></div>';
			}
		}

		function showAddCategoryForm() {
			document.getElementById('category-form-title').textContent = 'Add Category';
			document.getElementById('category-form').reset();
			document.getElementById('category-id').value = '';
			// Set default order to be after the last category
			document.getElementById('category-order').value = categoriesData.length > 0
				? Math.max(...categoriesData.map(c => c.displayOrder)) + 1
				: 0;
			document.getElementById('category-form-modal').classList.add('active');
		}

		function editCategory(categoryId) {
			const category = categoriesData.find(c => c.categoryId === categoryId);
			if (!category) return;

			document.getElementById('category-form-title').textContent = 'Edit Category';
			document.getElementById('category-id').value = category.categoryId;
			document.getElementById('category-name').value = category.name;
			document.getElementById('category-description').value = category.description || '';
			document.getElementById('category-order').value = category.displayOrder;
			document.getElementById('category-form-modal').classList.add('active');
		}

		function closeCategoryForm() {
			document.getElementById('category-form-modal').classList.remove('active');
			document.getElementById('category-form').reset();
		}

		document.getElementById('category-form').addEventListener('submit', async (e) => {
			e.preventDefault();

			const categoryId = document.getElementById('category-id').value;
			const formData = {
				name: document.getElementById('category-name').value,
				description: document.getElementById('category-description').value || null,
				displayOrder: parseInt(document.getElementById('category-order').value)
			};

			try {
				let response;
				if (categoryId) {
					// Update existing category
					response = await fetch(`/api/categories/${categoryId}`, {
						method: 'PATCH',
						headers: { 'Content-Type': 'application/json' },
						credentials: 'same-origin',
						body: JSON.stringify(formData)
					});
				} else {
					// Create new category
					response = await fetch('/api/categories', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						credentials: 'same-origin',
						body: JSON.stringify(formData)
					});
				}

				if (!response.ok) {
					const error = await response.json();
					throw new Error(error.error || 'Failed to save category');
				}

				closeCategoryForm();
				await loadCategories();
			} catch (error) {
				alert('Error saving category: ' + error.message);
			}
		});

		async function deleteCategory(categoryId) {
			if (!confirm('Are you sure you want to delete this category? Groups in this category will become uncategorized.')) {
				return;
			}

			try {
				const response = await fetch(`/api/categories/${categoryId}`, {
					method: 'DELETE',
					credentials: 'same-origin'
				});

				if (!response.ok) {
					const error = await response.json();
					throw new Error(error.error || 'Failed to delete category');
				}

				await loadCategories();
			} catch (error) {
				alert('Error deleting category: ' + error.message);
			}
		}

		// Check authentication first
		async function checkAuth() {
			try {
				const response = await fetch('/api/auth/check', {
					credentials: 'same-origin'
				});

				if (response.ok) {
					const data = await response.json();
					if (data.authenticated) {
						// Store admin status
						isAdmin = data.isAdmin || false;

						// Show/hide admin-only buttons
						if (isAdmin) {
							document.getElementById('manage-categories-btn').style.display = 'inline-block';
						}

						// User is authenticated, load groups
						loadMyGroups();
						return;
					}
				}

				// Not authenticated, redirect to home
				window.location.href = 'https://pleaseignore.app/';
			} catch (error) {
				console.error('Auth check failed:', error);
				window.location.href = 'https://pleaseignore.app/';
			}
		}

		// Initialize
		checkAuth();
	</script>
</body>
</html>
