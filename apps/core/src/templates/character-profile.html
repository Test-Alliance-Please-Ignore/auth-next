<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Character Profile - EVE Auth</title>
		<style>
			:root {
				--bg-primary: #0a0a0a;
				--bg-secondary: #1a1a1a;
				--bg-tertiary: #2a2a2a;
				--text-primary: #ffffff;
				--text-secondary: #a0a0a0;
				--text-tertiary: #606060;
				--border-color: #333;
				--accent-primary: #ffa500;
				--accent-success: #4caf50;
				--accent-danger: #f44336;
				--accent-info: #2196f3;
			}

			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family:
					'Inter',
					-apple-system,
					BlinkMacSystemFont,
					'Segoe UI',
					Roboto,
					sans-serif;
				background: var(--bg-primary);
				color: var(--text-primary);
				line-height: 1.6;
				min-height: 100vh;
			}

			.container {
				max-width: 1400px;
				margin: 0 auto;
				padding: 20px;
			}

			.header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 20px 0;
				border-bottom: 1px solid var(--border-color);
				margin-bottom: 30px;
			}

			.header h1 {
				font-size: 24px;
				font-weight: 600;
			}

			.nav-buttons {
				display: flex;
				gap: 10px;
			}

			.btn {
				padding: 8px 16px;
				background: var(--bg-secondary);
				border: 1px solid var(--border-color);
				color: var(--text-primary);
				border-radius: 6px;
				cursor: pointer;
				font-size: 14px;
				transition: all 0.2s;
				text-decoration: none;
				display: inline-block;
			}

			.btn:hover {
				background: var(--bg-tertiary);
			}

			.btn-primary {
				background: var(--accent-primary);
				border-color: var(--accent-primary);
				color: var(--bg-primary);
			}

			.btn-primary:hover {
				background: #ff8c00;
			}

			.loading {
				text-align: center;
				padding: 50px;
				color: var(--text-secondary);
			}

			.error {
				background: rgba(244, 67, 54, 0.1);
				border: 1px solid var(--accent-danger);
				padding: 15px;
				border-radius: 8px;
				margin: 20px 0;
			}

			.character-header {
				display: flex;
				gap: 30px;
				margin-bottom: 40px;
				padding: 30px;
				background: var(--bg-secondary);
				border-radius: 12px;
			}

			.character-portrait {
				flex-shrink: 0;
			}

			.character-portrait img {
				width: 128px;
				height: 128px;
				border-radius: 8px;
				border: 2px solid var(--border-color);
			}

			.character-info {
				flex-grow: 1;
			}

			.character-name {
				font-size: 32px;
				font-weight: 600;
				margin-bottom: 10px;
			}

			.character-meta {
				display: flex;
				flex-direction: column;
				gap: 8px;
				color: var(--text-secondary);
			}

			.meta-item {
				display: flex;
				align-items: center;
				gap: 8px;
			}

			.meta-label {
				color: var(--text-tertiary);
				min-width: 100px;
			}

			.ownership-badge {
				display: inline-block;
				padding: 4px 12px;
				background: var(--accent-success);
				color: white;
				border-radius: 4px;
				font-size: 12px;
				font-weight: 600;
				margin-left: 10px;
			}

			.tabs {
				display: flex;
				gap: 2px;
				border-bottom: 2px solid var(--border-color);
				margin-bottom: 30px;
			}

			.tab {
				padding: 12px 24px;
				background: transparent;
				border: none;
				color: var(--text-secondary);
				cursor: pointer;
				font-size: 14px;
				font-weight: 500;
				transition: all 0.2s;
				border-bottom: 2px solid transparent;
				margin-bottom: -2px;
			}

			.tab:hover {
				color: var(--text-primary);
			}

			.tab.active {
				color: var(--accent-primary);
				border-bottom-color: var(--accent-primary);
			}

			.tab-content {
				display: none;
			}

			.tab-content.active {
				display: block;
			}

			.section {
				background: var(--bg-secondary);
				border-radius: 12px;
				padding: 25px;
				margin-bottom: 20px;
			}

			.section-title {
				font-size: 18px;
				font-weight: 600;
				margin-bottom: 20px;
				color: var(--text-primary);
			}

			.skills-summary {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 20px;
				margin-bottom: 30px;
			}

			.stat-card {
				background: var(--bg-tertiary);
				padding: 20px;
				border-radius: 8px;
				text-align: center;
			}

			.stat-value {
				font-size: 28px;
				font-weight: 600;
				color: var(--accent-primary);
			}

			.stat-label {
				color: var(--text-secondary);
				font-size: 14px;
				margin-top: 5px;
			}

			.skills-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
				gap: 15px;
			}

			.skill-item {
				background: var(--bg-tertiary);
				padding: 15px;
				border-radius: 8px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.skill-name {
				font-weight: 500;
				color: var(--text-primary);
			}

			.skill-level {
				display: flex;
				gap: 4px;
			}

			.skill-pip {
				width: 12px;
				height: 12px;
				border: 1px solid var(--accent-primary);
				border-radius: 2px;
			}

			.skill-pip.filled {
				background: var(--accent-primary);
			}

			.skill-sp {
				color: var(--text-tertiary);
				font-size: 12px;
				margin-top: 4px;
			}

			.skill-queue-item {
				background: var(--bg-tertiary);
				padding: 15px;
				border-radius: 8px;
				margin-bottom: 10px;
			}

			.queue-header {
				display: flex;
				justify-content: space-between;
				margin-bottom: 10px;
			}

			.queue-progress {
				height: 4px;
				background: var(--bg-primary);
				border-radius: 2px;
				overflow: hidden;
			}

			.queue-progress-bar {
				height: 100%;
				background: var(--accent-primary);
				transition: width 0.3s;
			}

			.history-item {
				padding: 15px;
				border-left: 3px solid var(--border-color);
				margin-bottom: 15px;
				background: var(--bg-tertiary);
				border-radius: 0 8px 8px 0;
			}

			.history-item.corporation {
				border-left-color: var(--accent-info);
			}

			.history-item.alliance {
				border-left-color: var(--accent-success);
			}

			.history-date {
				color: var(--text-tertiary);
				font-size: 12px;
				margin-bottom: 5px;
			}

			.wallet-balance {
				font-size: 36px;
				font-weight: 600;
				color: var(--accent-success);
				margin: 20px 0;
			}

			.location-info {
				display: flex;
				flex-direction: column;
				gap: 15px;
			}

			.location-item {
				display: flex;
				gap: 10px;
				align-items: center;
			}

			.online-indicator {
				display: inline-block;
				width: 12px;
				height: 12px;
				border-radius: 50%;
				background: var(--accent-danger);
			}

			.online-indicator.online {
				background: var(--accent-success);
			}

			.description {
				background: var(--bg-tertiary);
				padding: 20px;
				border-radius: 8px;
				white-space: pre-wrap;
				line-height: 1.8;
				color: var(--text-secondary);
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>Character Profile</h1>
				<div class="nav-buttons">
					<a href="/dashboard" class="btn">Dashboard</a>
					<button id="refreshBtn" class="btn btn-primary">Refresh Data</button>
				</div>
			</div>

			<div id="loading" class="loading">Loading character data...</div>
			<div id="error" class="error" style="display: none"></div>
			<div id="content" style="display: none">
				<div class="character-header">
					<div class="character-portrait">
						<img id="portrait" src="" alt="Character Portrait" />
					</div>
					<div class="character-info">
						<div class="character-name">
							<span id="characterName"></span>
							<span id="ownershipBadge" class="ownership-badge" style="display: none">Your Character</span>
						</div>
						<div class="character-meta">
							<div class="meta-item">
								<span class="meta-label">Corporation:</span>
								<span id="corporation"></span>
							</div>
							<div class="meta-item">
								<span class="meta-label">Alliance:</span>
								<span id="alliance"></span>
							</div>
							<div class="meta-item">
								<span class="meta-label">Security Status:</span>
								<span id="secStatus"></span>
							</div>
							<div class="meta-item">
								<span class="meta-label">Birthday:</span>
								<span id="birthday"></span>
							</div>
						</div>
					</div>
				</div>

				<div class="tabs">
					<button class="tab active" data-tab="overview">Overview</button>
					<button class="tab" data-tab="skills">Skills</button>
					<button class="tab" data-tab="history">History</button>
					<button class="tab owner-only" data-tab="wallet" style="display: none">Wallet</button>
					<button class="tab owner-only" data-tab="location" style="display: none">Location</button>
				</div>

				<div id="overview" class="tab-content active">
					<div class="section">
						<h2 class="section-title">Description</h2>
						<div id="description" class="description">No description available.</div>
					</div>
				</div>

				<div id="skills" class="tab-content">
					<div class="section">
						<h2 class="section-title">Skill Summary</h2>
						<div class="skills-summary">
							<div class="stat-card">
								<div id="totalSP" class="stat-value">0</div>
								<div class="stat-label">Total SP</div>
							</div>
							<div class="stat-card">
								<div id="unallocatedSP" class="stat-value">0</div>
								<div class="stat-label">Unallocated SP</div>
							</div>
							<div class="stat-card">
								<div id="skillCount" class="stat-value">0</div>
								<div class="stat-label">Skills Trained</div>
							</div>
						</div>
					</div>

					<div class="section">
						<h2 class="section-title">Training Queue</h2>
						<div id="skillQueue">No skills in queue</div>
					</div>

					<div class="section">
						<h2 class="section-title">All Skills</h2>
						<div id="skillsList" class="skills-grid"></div>
					</div>
				</div>

				<div id="history" class="tab-content">
					<div class="section">
						<h2 class="section-title">Corporation & Alliance History</h2>
						<div id="historyList">Loading history...</div>
					</div>
				</div>

				<div id="wallet" class="tab-content">
					<div class="section">
						<h2 class="section-title">Wallet Balance</h2>
						<div id="walletBalance" class="wallet-balance">Loading...</div>
					</div>
				</div>

				<div id="location" class="tab-content">
					<div class="section">
						<h2 class="section-title">Current Location</h2>
						<div id="locationInfo" class="location-info">Loading...</div>
					</div>
				</div>
			</div>
		</div>

		<script>
			const characterId = new URLSearchParams(window.location.search).get('id')
			if (!characterId) {
				document.getElementById('error').textContent = 'No character ID provided'
				document.getElementById('error').style.display = 'block'
				document.getElementById('loading').style.display = 'none'
			}

			let characterData = null
			let isOwner = false

			// Tab switching
			document.querySelectorAll('.tab').forEach((tab) => {
				tab.addEventListener('click', () => {
					const targetTab = tab.dataset.tab
					document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'))
					document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'))
					tab.classList.add('active')
					document.getElementById(targetTab).classList.add('active')

					// Load tab-specific data
					if (targetTab === 'skills' && !document.getElementById('skillsList').children.length) {
						loadSkills()
					} else if (targetTab === 'history' && document.getElementById('historyList').textContent === 'Loading history...') {
						loadHistory()
					} else if (targetTab === 'wallet' && isOwner && document.getElementById('walletBalance').textContent === 'Loading...') {
						loadWallet()
					} else if (targetTab === 'location' && isOwner && document.getElementById('locationInfo').textContent === 'Loading...') {
						loadLocation()
					}
				})
			})

			async function loadCharacterData() {
				try {
					const response = await fetch(`/api/characters/${characterId}`)
					const data = await response.json()

					if (!response.ok) {
						throw new Error(data.error || 'Failed to load character data')
					}

					characterData = data.character
					isOwner = data.isOwner

					// Update UI
					document.getElementById('portrait').src = `/api/characters/${characterId}/portrait`
					document.getElementById('characterName').textContent = characterData.name
					document.getElementById('corporation').textContent = characterData.corporation
						? `[${characterData.corporation.ticker}] ${characterData.corporation.name}`
						: 'None'
					document.getElementById('alliance').textContent = characterData.allianceId ? `Alliance ID: ${characterData.allianceId}` : 'None'
					document.getElementById('secStatus').textContent =
						characterData.securityStatus !== null ? characterData.securityStatus.toFixed(2) : 'Unknown'
					document.getElementById('birthday').textContent = new Date(characterData.birthday).toLocaleDateString()
					document.getElementById('description').textContent = characterData.description || 'No description available.'

					if (isOwner) {
						document.getElementById('ownershipBadge').style.display = 'inline-block'
						document.querySelectorAll('.owner-only').forEach((el) => (el.style.display = 'block'))
					}

					document.getElementById('loading').style.display = 'none'
					document.getElementById('content').style.display = 'block'
				} catch (error) {
					console.error('Error loading character data:', error)
					document.getElementById('error').textContent = error.message
					document.getElementById('error').style.display = 'block'
					document.getElementById('loading').style.display = 'none'
				}
			}

			async function loadSkills() {
				try {
					const response = await fetch(`/api/characters/${characterId}/skills`)
					const data = await response.json()

					if (!response.ok) {
						throw new Error(data.error || 'Failed to load skills')
					}

					const skills = data.skills

					// Update summary
					document.getElementById('totalSP').textContent = skills.totalSP.toLocaleString()
					document.getElementById('unallocatedSP').textContent = skills.unallocatedSP.toLocaleString()
					document.getElementById('skillCount').textContent = skills.skills.length

					// Update skill queue
					const queueContainer = document.getElementById('skillQueue')
					if (skills.skillQueue.length > 0) {
						queueContainer.innerHTML = skills.skillQueue
							.map(
								(item) => `
							<div class="skill-queue-item">
								<div class="queue-header">
									<span>${item.skillName || `Skill ID: ${item.skillId}`} - Level ${item.finishedLevel}</span>
									<span>${item.finishDate ? new Date(item.finishDate).toLocaleString() : 'Paused'}</span>
								</div>
								${
									item.levelStartSP && item.levelEndSP
										? `<div class="queue-progress">
									<div class="queue-progress-bar" style="width: ${((item.trainingStartSP - item.levelStartSP) / (item.levelEndSP - item.levelStartSP)) * 100}%"></div>
								</div>`
										: ''
								}
							</div>
						`
							)
							.join('')
					} else {
						queueContainer.innerHTML = 'No skills in training queue'
					}

					// Update skills list
					const skillsContainer = document.getElementById('skillsList')
					skillsContainer.innerHTML = skills.skills
						.map(
							(skill) => `
						<div class="skill-item">
							<div>
								<div class="skill-name">${skill.skillName || `Skill ID: ${skill.skillId}`}</div>
								<div class="skill-sp">${skill.skillpoints.toLocaleString()} SP</div>
							</div>
							<div class="skill-level">
								${[1, 2, 3, 4, 5]
									.map((level) => `<div class="skill-pip ${level <= skill.trainedLevel ? 'filled' : ''}"></div>`)
									.join('')}
							</div>
						</div>
					`
						)
						.join('')
				} catch (error) {
					console.error('Error loading skills:', error)
					document.getElementById('skillsList').innerHTML = `<div class="error">Failed to load skills: ${error.message}</div>`
				}
			}

			async function loadHistory() {
				try {
					const response = await fetch(`/api/characters/${characterId}/history`)
					const data = await response.json()

					if (!response.ok) {
						throw new Error(data.error || 'Failed to load history')
					}

					const historyContainer = document.getElementById('historyList')
					if (data.history.length > 0) {
						historyContainer.innerHTML = data.history
							.map(
								(item) => `
							<div class="history-item ${item.fieldName}">
								<div class="history-date">${new Date(item.changedAt).toLocaleString()}</div>
								<div><strong>${item.fieldName}:</strong> ${item.oldValue || 'None'} → ${item.newValue || 'None'}</div>
							</div>
						`
							)
							.join('')
					} else {
						historyContainer.innerHTML = 'No history available'
					}
				} catch (error) {
					console.error('Error loading history:', error)
					document.getElementById('historyList').innerHTML = `<div class="error">Failed to load history: ${error.message}</div>`
				}
			}

			async function loadWallet() {
				try {
					const response = await fetch(`/api/characters/${characterId}/wallet`)
					const data = await response.json()

					if (!response.ok) {
						throw new Error(data.error || 'Failed to load wallet')
					}

					document.getElementById('walletBalance').textContent = `${data.wallet.balance.toLocaleString()} ISK`
				} catch (error) {
					console.error('Error loading wallet:', error)
					document.getElementById('walletBalance').innerHTML = `<div class="error">Failed to load wallet: ${error.message}</div>`
				}
			}

			async function loadLocation() {
				try {
					const response = await fetch(`/api/characters/${characterId}/location`)
					const data = await response.json()

					if (!response.ok) {
						throw new Error(data.error || 'Failed to load location')
					}

					const location = data.location
					const locationContainer = document.getElementById('locationInfo')
					locationContainer.innerHTML = `
					<div class="location-item">
						<span class="online-indicator ${location.online ? 'online' : ''}"></span>
						<span>${location.online ? 'Online' : 'Offline'}</span>
					</div>
					<div class="location-item">
						<span class="meta-label">Solar System:</span>
						<span>${location.solarSystemName || `System ID: ${location.solarSystemId}`}</span>
					</div>
					${
						location.stationId
							? `<div class="location-item">
						<span class="meta-label">Station:</span>
						<span>${location.stationName || `Station ID: ${location.stationId}`}</span>
					</div>`
							: ''
					}
					${
						location.structureId
							? `<div class="location-item">
						<span class="meta-label">Structure:</span>
						<span>${location.structureName || `Structure ID: ${location.structureId}`}</span>
					</div>`
							: ''
					}
					${
						location.ship
							? `<div class="location-item">
						<span class="meta-label">Ship:</span>
						<span>${location.ship.name} (${location.ship.typeName || `Type ID: ${location.ship.typeId}`})</span>
					</div>`
							: ''
					}
					${
						location.lastLogin
							? `<div class="location-item">
						<span class="meta-label">Last Login:</span>
						<span>${new Date(location.lastLogin).toLocaleString()}</span>
					</div>`
							: ''
					}
					${
						location.lastLogout
							? `<div class="location-item">
						<span class="meta-label">Last Logout:</span>
						<span>${new Date(location.lastLogout).toLocaleString()}</span>
					</div>`
							: ''
					}
				`
				} catch (error) {
					console.error('Error loading location:', error)
					document.getElementById('locationInfo').innerHTML = `<div class="error">Failed to load location: ${error.message}</div>`
				}
			}

			document.getElementById('refreshBtn').addEventListener('click', async () => {
				if (!isOwner) {
					alert('Only character owners can refresh data')
					return
				}

				try {
					const response = await fetch(`/api/characters/${characterId}/refresh`, { method: 'POST' })
					const data = await response.json()

					if (!response.ok) {
						throw new Error(data.error || 'Failed to refresh data')
					}

					alert('Character data refreshed successfully')
					window.location.reload()
				} catch (error) {
					alert(`Error: ${error.message}`)
				}
			})

			// Load initial data
			loadCharacterData()
		</script>
	</body>
</html>