#!/bin/sh
set -eu

# Find monorepo root and source .env if it exists
SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)
REPO_ROOT=$(cd "$SCRIPT_DIR/../../.." && pwd)
if [ -f "$REPO_ROOT/.env" ]; then
	set -a
	# shellcheck disable=SC1091
	. "$REPO_ROOT/.env"
	set +a
fi

# Extract name and version from package.json using jq
NAME=$(jq -r '.name' package.json)
VERSION=$(get-version)

# Deploy with wrangler using the extracted values as binding variables
echo "Deploying worker $NAME version $VERSION"
exec wrangler deploy \
	--var NAME:"$NAME" \
	--var SENTRY_RELEASE:"$VERSION" \
	"$@"
