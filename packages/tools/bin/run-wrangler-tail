#!/bin/sh
set -eu

# Find monorepo root by looking for pnpm-workspace.yaml
find_repo_root() {
	local dir="$PWD"
	while [ "$dir" != "/" ]; do
		if [ -f "$dir/pnpm-workspace.yaml" ]; then
			echo "$dir"
			return 0
		fi
		dir=$(dirname "$dir")
	done
	echo "Error: Could not find monorepo root (pnpm-workspace.yaml not found)" >&2
	exit 1
}

REPO_ROOT=$(find_repo_root)

NAME=$(jq -r '.name' package.json)

# Auto-reconnect with exponential backoff
BACKOFF=1
MAX_BACKOFF=30

# Trap SIGTERM and SIGINT for graceful shutdown
trap 'echo "Stopping tail for $NAME..."; exit 0' TERM INT

echo "Starting tail for $NAME (auto-reconnect enabled)..."

while true; do
	echo "Connecting to $NAME logs..."

	# Run wrangler tail with env file - will exit when disconnected
	if wrangler tail "$NAME" --env-file "$REPO_ROOT/.env" "$@"; then
		# Clean exit (user pressed Ctrl+C)
		exit 0
	else
		EXIT_CODE=$?
		echo "Disconnected from $NAME (exit code: $EXIT_CODE). Reconnecting in ${BACKOFF}s..."
		sleep "$BACKOFF"

		# Exponential backoff
		BACKOFF=$((BACKOFF * 2))
		if [ "$BACKOFF" -gt "$MAX_BACKOFF" ]; then
			BACKOFF=$MAX_BACKOFF
		fi
	fi
done
