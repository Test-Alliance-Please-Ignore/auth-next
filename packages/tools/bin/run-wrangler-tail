#!/bin/sh
set -eu

# Find monorepo root and source .env if it exists
SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)
REPO_ROOT=$(cd "$SCRIPT_DIR/../../.." && pwd)
if [ -f "$REPO_ROOT/.env" ]; then
	set -a
	# shellcheck disable=SC1091
	. "$REPO_ROOT/.env"
	set +a
fi

NAME=$(jq -r '.name' package.json)

# Auto-reconnect with exponential backoff
BACKOFF=1
MAX_BACKOFF=30

# Trap SIGTERM and SIGINT for graceful shutdown
trap 'echo "Stopping tail for $NAME..."; exit 0' TERM INT

echo "Starting tail for $NAME (auto-reconnect enabled)..."

while true; do
	echo "Connecting to $NAME logs..."

	# Run wrangler tail - will exit when disconnected
	if wrangler tail "$NAME" "$@"; then
		# Clean exit (user pressed Ctrl+C)
		exit 0
	else
		EXIT_CODE=$?
		echo "Disconnected from $NAME (exit code: $EXIT_CODE). Reconnecting in ${BACKOFF}s..."
		sleep "$BACKOFF"

		# Exponential backoff
		BACKOFF=$((BACKOFF * 2))
		if [ "$BACKOFF" -gt "$MAX_BACKOFF" ]; then
			BACKOFF=$MAX_BACKOFF
		fi
	fi
done
